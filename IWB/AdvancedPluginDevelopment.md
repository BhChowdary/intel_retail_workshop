# Enhancing the Intel Unite® Plugin and Integration with external solutions
## Lab Overview
In the previous lab a sample Intel Unite® Plugin is developed to display Toast messages on the hub. In this lab, the functionality of sample plugin is enhanced to capture the no. of users connected to and presenting on the Intel Unite®. Also, the integration of the plugin with OpenVINO™ toolkit is covered in this lab.

## Tasks to be done in this lab
- Enhancing the sample plugin UI for additional functionalities
- Capturing the Intel Unite® session data using Intel Unite® Plugin SDK
- Developing an external widget solution based on OpenVINO™ Toolkit       
- Intel Unite® Plugin integration with the external widget solution

### Enhancing the sample plugin UI for additional functionalities
The plugin can be customized using various options provided in the Intel Unite® Plugin SDK.
- Replace #TODO:  Declaring variables for advanced plugin
- Paste the following lines
```c
const string LAUNCHAPP = "00000000-0000-0000-0000-000000000009";
const string CLOSEAPP = "00000000-0000-0000-0000-000000000010";
String str = null;
String filepath = @"C:\\Users\\intel1672\\Desktop\\Retail\\05-OpenVINO\\UniteData.json";
Process p = null;
```

- Replace #TODO: Adding UI elements for advanced plugin
- Paste the following lines

```c
uiElementGroup.UIElements.Add(new PluginUIElement(new Guid(LAUNCHAPP), UIElementType.Button, "Launch Analytics", "", ResourceToBytes(new Uri("/AttendeeAnalyticsPlugin;component/launch.png", System.UriKind.Relative))));

uiElementGroup.UIElements.Add(new PluginUIElement(new Guid(CLOSEAPP), UIElementType.Button, "Close Analytics", "", ResourceToBytes(new Uri("/AttendeeAnalyticsPlugin;component/close.png", System.UriKind.Relative))));
```

###  Capturing the Intel Unite® session data  using Intel Unite® Plugin SDK
To dive deep, the real time application data of the Intel Unite® can be captured using the CFCPlugin library. The ```UserEventArgs``` object holds list of CurrentUsers. ```e.CurrentUsers.count``` gives the no. of Unite® clients connected to the hub. Using the CFCPlugin, no of users presenting desktop can be captured.
- Replace #TODO: fetch Intel Unite application data
- Paste the following lines
```c
public int GetNoOfPresenters(UserEventArgs e)
{
    int i = 0;
    foreach (UserInfo user in e.CurrentUsers) // Loop through List with foreach
    {
        if (user.isPresenting)
        {
            i++;
        }
    }
    return i;
}
```

The above captured data are to be saved in JSON format for integration with external widget solution ( discussed in the next tasks). This data should be updated when a user connects/ disconnects and when a user presentation starts/ends.

- Replace #TODO: Implementing Overridden method for Advanced plugin
- Paste the following lines

```c
str = "{\"usersConnected\":" + e.CurrentUsers.Count + ",\n\"usersPresenting\":" + GetNoOfPresenters(e) + ",\n\"timestamp\":\"" + DateTime.Now.ToString("h:mm:ss") + "\"}";
System.IO.File.WriteAllText(filepath, str);
```
### Developing an external widget solution based on OpenVINO™ Toolkit
The external widget solution that is being developed will fetch data from the two different applications, OpenVINO™ Toolkit application and the Intel Unite® plugin application.

On the hub, run interactive_face_detection_sample.exe which is at the path, ***C:\Users\intel1672\Desktop\Retail\05-OpenVINO\deployment_tools\inference_engine\bin\intel64\Debug***

Create a python file with Widget.pyw in the path C:\Users\intel1672\Desktop\Retail\05-OpenVINO.

The Python application reads the live data generated by Intel Unite plugin and interactive_face_detection_sample application and performs analytics on the data to calculate Average number of people, number of males and number females present in the room. The application calculates these values for every 5 minutes. The application displays this information on the hub which can be seen by all the participants connected to hub.

Paste the following code.
```c
import time
from threading import Timer
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import json
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import matplotlib as mpl
import matplotlib.pyplot as plt
import numpy as np
import plotly.plotly as py
import tkinter as tk
from tkinter import *
from threading import Thread

connections = [0]
presentations = [0]
facecount = [0]
malecount = [0]
femalecount=[0]
unite_timestamp = [0]
ov_temp = [0]
ov_timestamp = [0]
ov_flag = False
unite_flag =False
counter = 0;
flag = False

class Handler(FileSystemEventHandler):

    def invokeWidget(self):
        print(" inside invokeWidget")
        updateWindow()
        Timer(15, self.invokeWidget, ()).start()

    def on_any_event(self,event):
        global unite_flag,ov_flag
        print("Inside  change");
        print(event.src_path);
        if(event.src_path=="C:\\Users\\intel1672\\Desktop\\Retail\\05-OpenVINO\\file.json"):
                 self.jsonRead_OVData(event.src_path)
        elif(event.src_path=="C:\\Users\\intel1672\\Desktop\\Retail\\05-OpenVINO\\UniteData.json"):
                 self.jsonRead_uniteData(event.src_path)
        if unite_flag==True or ov_flag==True:
             unite_flag=False
             ov_flag=False


    def jsonRead_uniteData(self,path):
        global unite_flag
        with open(path) as f2:
            UniteData = json.load(f2)
        if(unite_timestamp[-1]!=UniteData["timestamp"]):
            unite_flag = True
            unite_timestamp.append(UniteData["timestamp"])
            connections.append(UniteData["usersConnected"])
            presentations.append(UniteData["usersPresenting"])


    def jsonRead_OVData(self,path):
        global ov_flag
        OVData=[]
        try:
            with open(path) as f1:
                OVData = json.load(f1)
            if(OVData== None):
                print("no value read from openvino")
            if(ov_timestamp[-1]!=OVData["timestamp"]):
                ov_flag=True
                ov_timestamp.append(OVData["timestamp"])
                facecount.append(OVData["facecount"])
                malecount.append(OVData["malecount"])
                femalecount.append(OVData["femalecount"])
        except:
            print("Unexpected error occured")


class MyThread(Thread):
    def __init__(self):
        ''' Constructor. '''
        Thread.__init__(self)


    def run(self):
        print("in run")
        event_handler=Handler()
        observer = Observer()
        observer.schedule(event_handler, "C:\\Users\\intel1672\\Desktop\\Retail\\05-OpenVINO", recursive=False)
        observer.start()
        observer.join()
        print("leaving run")


def updateWindow():

    global flag
    global counter
    if(len(malecount) and len(femalecount)):
        malemean = sum(malecount)/len(malecount)
        femalemean = sum(femalecount)/len(femalecount)
        del malecount[:]
        del femalecount[:]
    else:
        malemean=0
        femalemean=0


    ov_temp.append(counter)
    counter=counter+1
    plt.clf()
    ax = plt.gca()
    plt.axis('off')
    print (connections[-1])
    temptext="  Intel Unite®  Connections :"+ str(connections[-1])+"\n  Male Count :"+str(int(malemean))+"\n  Female Count :"+str(int(femalemean))
    plt.text(0.0, 0.2, temptext, fontsize=13,transform=plt.gcf().transFigure)
    flag = True
    fig.canvas.draw()
    print("plotted graph");


event_handler = Handler()
Timer(0, event_handler.invokeWidget, ()).start()
myThreadOb1 = MyThread()
myThreadOb1.setName('Thread 1')
myThreadOb1.start()
# This defines the Python GUI backend to use for matplotlib
mpl.use('tkAgg')

# Initialize an instance of Tk
root = tk.Tk()
root.overrideredirect(1)


# Initialize matplotlib figure for graphing purposes
fig = plt.figure(figsize=(3,1), dpi=100)

# Special type of "canvas" to allow for matplotlib graphing
canvas = FigureCanvasTkAgg(fig, master=root)

plot_widget = canvas.get_tk_widget()
males = np.array(malecount)
females = np.array(femalecount)
plot_widget.grid(row=0, column=0)
root.mainloop()
```

### Intel Unite® Plugin integration with the external widget solution
For controlling the above created external widget solution, events of LAUNCHAPP and CLOSEAPP should be handled.
- Replace #TODO: Handling more events
- Paste the following lines

 ```c
 case LAUNCHAPP:
     if (this.p != null)
     {
         HubText = "User '" + e.TargetUser.Name.ToUpper() + "'" + " App already running";
         ShowHubToast(HubText, currentStateImage, 5);
     }
     else
     {
         this.p = Process.Start("C:\\Users\\intel1672\\Desktop\\Retail\\05-OpenVINO\\Widget.pyw");
     }
     break;

 case CLOSEAPP:
     if (this.p != null)
     {
         this.p.Kill();
         this.p = null;
     }
     else
     {
         HubText = "User '" + e.TargetUser.Name.ToUpper() + "':" + " The App is not running";
         ShowHubToast(HubText, currentStateImage, 5);
         this.p = null;
     }
     break;
 ```

## Final Solution
Build solution and deploy the AttendeeAnalyticsPlugin.dll by following the  previously discussed steps in sample plugin development.

In the client application, click in the Attendee Analytics plugin.
    ![](../images/integration_1.JPG)

 launch Analytics when clicked shows the following widget on the hub.

   ![](../images/widgetoutput.JPG)

The code of this solution is available [here](../solutions/AdvancedPluginSolution.md)

## Lesson Learnt
- Understanding the capabilities of Intel Unite® Plugin
- Integration of the plugin with external solution based on OpenVINO™ toolkit
